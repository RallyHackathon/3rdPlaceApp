<!DOCTYPE html>
<html>
<head>
    <title>3rdPlaceApp</title>

    <script type="text/javascript" src="/apps/2.0rc1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",items:[{xtype:"container",itemId:"DashboardContainer",border:0,margin:0,style:{background:"green"},items:[{xtype:"container",itemId:"DescriptionHeader",colspan:1,border:1,margin:12,style:{borderStyle:"solid"}},{xtype:"container",itemId:"SummaryContent",colspan:1,border:0,margin:6,layout:"column",items:[{xtype:"container",itemId:"HealthPanel",columnWidth:.3,border:0,margin:0,items:[{xtype:"container",itemId:"ReleaseNotes",colspan:1,border:1,margin:6,style:{borderStyle:"solid"}},{xtype:"container",itemId:"FeatureStatus",colspan:1,border:1,margin:6,style:{borderStyle:"solid"}},{xtype:"container",itemId:"BlockedWork",colspan:1,border:1,margin:6,style:{borderStyle:"solid"}}]},{xtype:"container",itemId:"Chart",columnWidth:.7,border:0,margin:6,layout:"fit",height:500,width:500,listeners:{afterrender:function(){this.loadMask=new Ext.LoadMask(this,{msg:"Chart Loading..."}),this.loadMask.show(),this.on("demask",function(){this.loadMask.hide()})}}}]}]}],launch:function(){this._CurrentReleaseData(),this._BlockedStoriesbyReleaseData(),this._getReleaseData()},_CurrentReleaseData:function(){var CurrentReleaseStore=Ext.create("Rally.data.WsapiDataStore",{model:"Release",autoLoad:!0,filters:[{property:"ReleaseStartDate",operator:"<",value:"today"},{property:"ReleaseDate",operator:">",value:"today"}],context:{project:this.getContext().getProjectRef(),projectScopeUp:!1,projectScopeDown:!1},listeners:{load:function(store,currentreldata,success){this._GenerateReleaseDescription(store),this._GenerateFeatureData(currentreldata[0].get("_ref")),this._GenerateReleaseNoteGrid(store)},scope:this},scope:this})},_GenerateReleaseDescription:function(myStore){var myContainer=this.down("#DescriptionHeader");myContainer.panel=new Ext.Panel({html:myStore.data.items[0].data.Project._refObjectName+""+" Release Status",style:{"text-align":"center"},bodyStyle:{background:"#B0C4DE","font-size":"1.75em",padding:"2px","box-shadow":"inset 0 0 10px #157AB6"}}),myContainer.add(myContainer.panel),myContainer.descriptionheadergrid=Ext.create("Rally.ui.grid.Grid",{store:myStore,showPagingToolbar:!1,disableSelection:!0,columnCfgs:[{text:"Release Name",dataIndex:"Name",flex:1,sortable:!1},{text:"Release Theme",dataIndex:"Theme",flex:3,sortable:!1},{text:"Release Date",dataIndex:"ReleaseDate",renderer:function(value){return dateVal=new Date(value),dateVal=Ext.Date.format(dateVal,"F j, Y")},flex:1,sortable:!1}]}),myContainer.add(myContainer.descriptionheadergrid)},_GenerateReleaseNoteGrid:function(myStore){var myContainer=this.down("#ReleaseNotes");myContainer.notesGrid=Ext.create("Rally.ui.grid.Grid",{disableSelection:!0,viewConfig:{listeners:{cellclick:function(view,cell,cellIndex,therecord,row,rowIndex,e){Ext.create("Rally.ui.dialog.RichTextDialog",{autoShow:!0,resizable:!0,draggable:!0,title:"Edit Impediments of "+therecord.get("Name"),record:therecord,fieldName:"Notes",width:400,height:250})}}},store:myStore,showPagingToolbar:!1,columnCfgs:[{text:"Name",dataIndex:"Name",flex:1,sortable:!1},{text:"Impediments",dataIndex:"Notes",flex:2,sortable:!1}],title:"Impediments",titleAlign:"center",hideHeaders:!0,enableEditing:!0}),myContainer.add(myContainer.notesGrid)},_BlockedStoriesbyReleaseData:function(){var storyStore=Ext.create("Rally.data.WsapiDataStore",{model:"User Story",autoLoad:!0,fetch:["FormattedId","Name","BlockedReason","Feature","Project","_ref"],filters:[{property:"Release.ReleaseStartDate",operator:"<",value:"today"},{property:"Release.ReleaseDate",operator:">",value:"today"},{property:"Blocked",operator:"=",value:"true"},{property:"Iteration.Name",operator:"!=",value:""}],sorters:[{property:"Feature",direction:"ASC"}],listeners:{load:function(store,stories){if(0===stories.length){var myContainer=this.down("#BlockedWork");myContainer.panel=new Ext.Panel({title:"Blocked Stories",titleAlign:"center",html:"<I>No Stories Currently Blocked</I>",style:{"text-align":"center"},bodyStyle:{"font-size":"1.0em",padding:"2px"}}),myContainer.add(myContainer.panel)}else this._GenerateBlockedStoriesGrid(store)},scope:this}})},_GenerateBlockedStoriesGrid:function(myStore){var myContainer=this.down("#BlockedWork");myContainer.blockedGrid=Ext.create("Rally.ui.grid.Grid",{store:myStore,pagesize:25,showPagingToolbar:!1,disableSelection:!0,columnCfgs:[{text:"Feature",dataIndex:"Feature",flex:1,sortable:!1,renderer:function(value,meta,record){if(null!==value){var proj=record.get("Project")._ref;proj+="",proj=proj.substr(9);var link="../#/"+proj+"/detail"+(value._ref+"");return'<a href="'+link+'"target="_parent">'+value.Name+"</a>"}return"<I>No Feature</I>"}},{text:"Blocked Story",dataIndex:"Name",flex:1,sortable:!1,renderer:function(value,meta,record){var proj=record.get("Project")._ref;proj+="",proj=proj.substr(9);var link="../#/"+proj+"/detail/userstory/"+(record.get("_ref").split("/")[2]+"");return'<a href="'+link+'"target="_parent">'+value+"</a>"}},{text:"Blocked Reason",dataIndex:"BlockedReason",flex:1,sortable:!1}],title:"Blocked Stories",titleAlign:"center"}),myContainer.add(myContainer.blockedGrid)},_getReleaseData:function(){this.releaseTally={},Ext.create("Rally.data.WsapiDataStore",{model:"Release",autoLoad:"true",pageSize:500,sorters:[{property:"ReleaseStartDate",direction:"ASC"}],context:{project:this.getContext().getProjectRef(),projectScopeUp:!1,projectScopeDown:!1},listeners:{load:function(store,releaseRecords,success){Ext.each(releaseRecords,function(releaseRecord,index){this.releaseTally[releaseRecord.get("ObjectID")]={data:[],releaseName:releaseRecord.get("Name"),releaseDate:releaseRecord.get("ReleaseDate")}},this),this._queryRelCumFlowRecords(releaseRecords)},scope:this}})},_queryRelCumFlowRecords:function(releaseRecords){this.relObjQueryFilters=[],this.relObjIDs=[],Ext.each(releaseRecords,function(releaseRecord,index){this.relObjQueryFilters.push({property:"ReleaseObjectID",operatation:"=",value:releaseRecord.get("ObjectID")}),this.relObjIDs.push(releaseRecord.get("ObjectID"))},this);var filter=Rally.data.QueryFilter.or(this.relObjQueryFilters);this.orderedDates=[],Ext.create("Rally.data.WsapiDataStore",{model:"ReleaseCumulativeFlowData",autoLoad:"true",limit:5e3,sorters:[{property:"CreationDate",direction:"ASC"}],filters:filter,listeners:{load:function(store,releasesCumFlowRecs,success){Ext.each(releasesCumFlowRecs,function(releasesCumFlowRecs,index){var relObjID=releasesCumFlowRecs.get("ReleaseObjectID");void 0===this.releaseTally[relObjID]&&(this.releaseTally[relObjID]={});var creationDate=releasesCumFlowRecs.get("CreationDate");creationDate=Ext.Date.format(new Date(creationDate),"Y-M-d"),void 0===this.releaseTally[relObjID][creationDate]&&(this.releaseTally[relObjID][creationDate]={acceptedCount:0,totalCount:0},this.orderedDates.push(Ext.Date.format(new Date(creationDate),"Y-M-d"))),"Accepted"===releasesCumFlowRecs.get("CardState")&&(this.releaseTally[relObjID][creationDate].acceptedCount=releasesCumFlowRecs.get("CardEstimateTotal")),this.releaseTally[relObjID][creationDate].totalCount+=releasesCumFlowRecs.get("CardEstimateTotal")},this),this._extendDataPoints(),this._createChartSeries(),this._createChart()},scope:this}})},_extendDataPoints:function(){Ext.each(this.orderedDates,function(orderedDate,index){Ext.each(this.relObjIDs,function(relObjID,relIndex){void 0===this.releaseTally[relObjID][orderedDate]&&(this.releaseTally[relObjID][orderedDate]={acceptedCount:0},this.releaseTally[relObjID][orderedDate].totalCount||(this.releaseTally[relObjID][orderedDate].totalCount=0),index>1&&(this.releaseTally[relObjID][orderedDate].acceptedCount=this.releaseTally[relObjID][this.orderedDates[index-1]].acceptedCount,this.releaseTally[relObjID][orderedDate].totalCount=this.releaseTally[relObjID][this.orderedDates[index-1]].totalCount))},this)},this);for(var finalRelObjID=this.relObjIDs[this.relObjIDs.length-1],finalRelEndDate=new Date(this.releaseTally[finalRelObjID].releaseDate),lastChartedDate=new Date(this.orderedDates[this.orderedDates.length-1]),elapsedMs=Ext.Date.getElapsed(finalRelEndDate,lastChartedDate),elapsedDays=Math.ceil(elapsedMs/864e5),bufferDays=15,i=1;elapsedDays+bufferDays>=i;i++){var lastDateIncr=Ext.Date.add(lastChartedDate,Ext.Date.DAY,i),lastDateIncrFormatted=Ext.Date.format(lastDateIncr,"Y-M-d");this.orderedDates.push(lastDateIncrFormatted)}},_createChartSeries:function(){this.series=[];for(var numYAxes=this.relObjIDs.length,i=0;numYAxes>i;i++)if(void 0===this.series[i]&&(seriesName=0===i?"Accepted":this.releaseTally[this.relObjIDs[i]].releaseName,this.series[i]={data:[],seriesName:seriesName}),0===i){var j=0;Ext.each(this.orderedDates,function(orderedDate,index){var accumulatedTotal=0;Ext.each(this.relObjIDs,function(relObjID,index){void 0!==this.releaseTally[relObjID][orderedDate]&&(accumulatedTotal+=this.releaseTally[relObjID][orderedDate].acceptedCount)},this),this.series[i].data[j]=0,this.series[i].data[j]=void 0!==accumulatedTotal?accumulatedTotal:this.series[i].data[j-1],j++},this)}else if(1===i){var accumulatedTotal=0,j=0;Ext.each(this.orderedDates,function(orderedDate,index){var myRelObjID=this.relObjIDs[i-1];void 0!==this.releaseTally[myRelObjID][orderedDate]&&(accumulatedTotal=this.releaseTally[myRelObjID][orderedDate].totalCount),this.series[i].data[j]=0,this.series[i].data[j]=void 0!==accumulatedTotal?accumulatedTotal:this.series[i].data[j-1],j++},this)}else{var j=0;Ext.each(this.orderedDates,function(orderedDate,index){var myRelObjID=this.relObjIDs[i-1];void 0!==this.releaseTally[myRelObjID][orderedDate]&&(accumulatedTotal=this.releaseTally[myRelObjID][orderedDate].totalCount),this.series[i].data[j]=0,this.series[i].data[j]=void 0!==accumulatedTotal?accumulatedTotal:this.series[i].data[j-1],this.series[i].data[j]+=this.series[i-1].data[j],j++},this)}},_GenerateFeatureData:function(releaseRef){var featureStore=Ext.create("Rally.data.WsapiDataStore",{model:"Portfolio Item/Feature",autoLoad:!0,filters:[{property:"Release.ObjectID",operator:"=",value:releaseRef.split("/")[2]}],sorters:[{property:"PercentDoneByStoryPlanEstimate",direction:"DESC"}],listeners:{load:function(store,features){if(null===features||0===features.length){var myContainer=this.down("#FeatureStatus");myContainer.panel=new Ext.Panel({title:"Feature Status",titleAlign:"center",html:"<I>No Features Defined for this Release</I>",style:{"text-align":"center"},bodyStyle:{"font-size":"1.0em",padding:"2px"}}),myContainer.add(myContainer.panel)}else this._GenerateFeatureGrid(store)},scope:this}})},_GenerateFeatureGrid:function(myStore){var myContainer=this.down("#FeatureStatus");myContainer.featureGrid=Ext.create("Rally.ui.grid.Grid",{pagesize:25,showPagingToolbar:!1,disableSelection:!0,store:myStore,columnCfgs:[{text:"Feature",dataIndex:"Name",flex:1,sortable:!1,renderer:function(value,meta,record){var proj=record.get("Project")._ref;proj+="",proj=proj.substr(9);var link="../#/"+proj+"/detail"+(record.get("_ref")+"");return'<a href="'+link+'"target="_parent">'+value+"</a>"}},{text:"Percent Complete",flex:1,xtype:"templatecolumn",tpl:Ext.create("Rally.ui.renderer.template.progressbar.PortfolioItemPercentDoneTemplate",{percentDoneName:"PercentDoneByStoryPlanEstimate"})}],title:"Feature Status",titleAlign:"center"}),myContainer.add(myContainer.featureGrid)},_createPlotLines:function(){var relEndDates=[],plotLines=[];return Ext.each(this.relObjIDs,function(relObjID,index){var relEndDate=this.releaseTally[relObjID].releaseDate,relName=this.releaseTally[relObjID].releaseName,formattedRelEndDate=Ext.Date.format(new Date(relEndDate),"Y-M-d"),dateIndex=Ext.Array.indexOf(this.orderedDates,formattedRelEndDate);dateIndex>0&&plotLines.push({color:"red",value:dateIndex,width:1,zIndex:10,label:{rotation:90,text:relName}})},this),plotLines},_createChart:function(){var chartContainer=this.down("#Chart"),plotLines=this._createPlotLines(),myChart=Ext.create("Rally.ui.chart.Chart",{width:500,height:500,chartData:{series:[{type:"area",name:this.series[0].seriesName,data:this.series[0].data},{type:"line",name:this.series[1].seriesName,data:this.series[1].data},{type:"line",name:this.series[2].seriesName,data:this.series[2].data},{type:"line",name:this.series[3].seriesName,data:this.series[3].data}]},chartConfig:{chart:{zoomType:"xy",spacingRight:20},title:{text:"Release Burnup"},subtitle:{text:""},xAxis:{categories:this.orderedDates,title:"x title",plotLines:plotLines},yAxis:[{title:{text:"Points"}}],tooltip:{shared:!0},plotOptions:{line:{dashStyle:"shortDash",lineWidth:1,marker:{enabled:!1}},area:{lineWidth:1,lineColor:"black",marker:{enabled:!1}}}}});chartContainer.add(myChart),chartContainer.fireEvent("demask")}});

            Rally.launchApp('CustomApp', {
                name:"3rdPlaceApp",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app {
     /* Add app styles here */
}

    </style>
</head>
<body></body>
</html>
